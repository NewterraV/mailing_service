# Сервис рассылок
Сервис для автоматической рассылки сообщений.

## Содержание
- [Описание групп](#описание-групп)
- [Описание основной логики работы](#описание-основной-логики-работы)
- [Функции](#функции)
- [Установка](#установка)
- [Команды для работы через терминал](#команды-для-работы-через-терминал)

### Описание групп
Приложение имеет две заранее настроенные категории пользователей: 

```user``` - обычный пользователь

Может создавать, просматривать и редактировать рассылки и получателей рассылок. 
Может приостанавливать рассылки и выполнять принудительную их отправку.

```manager``` - модератор или сотрудник
Ограничен в возможностях работы с рассылками и получателями.
Может отключать рассылки.
Имеет возможность блокировки отдельных пользователей

### Описание основной логики работы

##### 1.1 Проверка на изменение статуса отправки
Каждые сутки в 0 часов все рассылки проходят процедуру проверки на изменение статуса отправки.
Если функция проверки определила, что рассылка находится в периоде отправки, а дата указанная
для следующей отправки совпадает с текущей датой, то рассылке присваивается статус ```отправить сегодня```, а состояние
меняется на ```запущена```.
Если текущая дата больше даты окончания рассылки, то присваивается статус ```завершена```, меньше - ```создана```.

##### 1.2 Отправка сообщений рассылки
Раз в минуту запускается функция отправки сообщений. Она получает список рассылок со статусом 
```отправить сегодня``` и сравнивает время отправки с текущим временем, если текущее время больше времени отправки,
к дате следующей отправки прибавляется значение периодичности (день, неделя, месяц) отправки. 
После проверяется статус активности рассылки (смотри функцию [2.1](#21-отключение-рассылок)) и 
выполняется отправка согласно настройкам рассылки, снимается статус ```отправить сегодня```. 
Если дата следующей отправки больше чем дата окончания рассылки - устанавливается состояние ```завершена```

##### 1.3 Создание рассылки
При создании либо обновлении рассылки принудительно запускается проверка на изменение статуса отправки 
(смотри параграф [1.1](#11-проверка-на-изменение-статуса-отправки))
Если проверка определила, что рассылка должна быть отправлена в текущую дату, то рассылка попадает в очередь на отправку 
(смотри параграф [1.2](#12-отправка-сообщений-рассылки)). 
Обратите внимание: ```если время указанное для отправки рассылки меньше текущего - рассылка будет выполнена немедленно.```
дальнейшие рассылки будут выполняться в указанное время.


### Функции

##### 2.1 Отключение рассылок
Пользователь с уровнем доступа ```manager``` может принудительно отключать любые рассылки других пользователей.
При отключении рассылке присваивается статус ```отключена``` после чего рассылка не может быть отправлена,
однако её дата следующей отправки продолжит меняться согласно периоду рассылки.
После включения, немедленно выполняется функция проверки на изменение статуса отправки 
(смотри параграф [1.1](#11-проверка-на-изменение-статуса-отправки))

##### 2.2 Блокировка пользователей
Пользователь с уровнем доступа ```manager``` может блокировать пользователей платформы. При блокировке пользователя 
автоматически будут отключены все его рассылки (смотри параграф [2.1](#21-отключение-рассылок)), 
~~а на почту пользователя поступит уведомление~~(в разработке). При разблокировке все рассылки пользователя пройдут 
процедуру проверки на изменение статуса отправки 
(смотри параграф [1.1](#11-проверка-на-изменение-статуса-отправки)) и станут активными.

##### 2.3 Приостановка рассылки
Пользователь с уровнем доступа ```user``` может приостановить любую рассылку, статус ```отправить сегодня```
если был активен - снимется, состояние изменится на ```приостановлена```. При активации рассылки, немедленно выполняется
функция проверки на изменение статуса отправки (смотри параграф [1.1](#11-проверка-на-изменение-статуса-отправки)) и по решению данной 
функции присваивается состояние и статус рассылки. Однако если рассылка была отключена модератором 
(смотри параграф [2.1](#21-отключение-рассылок)), то отправлена она не будет.
Приостановка рассылки не влияет на статус активации.

##### 2.4 Принудительная отправка рассылки
Пользователь с уровнем доступа ```user``` может принудительно отправить любую рассылкую При этом статус рассылки 
не имеет значения, после отправки никакие настройки не изменятся. Однако если рассылка была отключена модератором 
(смотри параграф [2.1](#21-отключение-рассылок)), то отправлена она не будет.


## Установка
### Зависимости
    python = "^3.11"
    django = "^4.2.4"
    psycopg2-binary = "^2.9.7"
    python-dotenv = "^1.0.0"
    django-crispy-forms = "^2.0"
    crispy-bootstrap5 = "^0.7"
    django-crontab = "^0.7.1"
    pillow = "^10.0.0"
    redis = "^5.0.0"
Управление через менеджер зависимостей ```Poetry```:
```sh
$ pip install poetry
```
Установка зависимостей:
```sh
$ poetry install
```

### Базовая настройка
Выполнить настройку в файле ```.env```

Обновить crontub задачи:
```sh
$ python manage.py crontab add
```



### Настройка тестовой версии

Пароль всех тестовых учетных записей: ```qwer1234qwer```

```test@manager.com - manager```
```test@user.com - user```
```test2@user.com - user```

Пароль учетной записи ```admin@admin.com```: ```admin1234```

#### Добавление тестовой информации:
```sh
$ python manage.py loaddata auth.json
$ python manage.py loaddata users.json
$ python manage.py loaddata client_data.json
$ python manage.py loaddata mailing_data.json
$ python manage.py loaddata blog_data.json
$ python manage.py crontab add
```

Для проверки отправки на реальные почтовые сервисы, необходимо отредактировать клиентов рассылки 
(тестовые email не существуют)

### Команды для работы через терминал
Создание суперпользователя:
```sh
$ python3 manage.py csu
```

Отправка ближайших сообщений если есть:
```sh
$ python3 manage.py sm
```

Обновление статуса всех рассылок:
```sh
$ python3 manage.py setstate
```
